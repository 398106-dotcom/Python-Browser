import os
import sys
import subprocess
import traceback

PROJECT_FOLDER = os.path.abspath(".")
BROWSER_FILE = os.path.join(PROJECT_FOLDER, "Browser.py")
RUN_FILE = os.path.join(PROJECT_FOLDER, "RunBrowser.bat")
DATA_FOLDER = os.path.join(PROJECT_FOLDER, "data")
INFO_FILE = os.path.join(DATA_FOLDER, "INFO.txt")
CRASH_LOG = os.path.join(PROJECT_FOLDER, "SETUP_CRASH_LOG.txt")

REQUIRED_PACKAGES = ["PyQt6", "PyQt6-WebEngine", "cryptography"]

def install_packages():
    import importlib.util
    missing_packages = []
    for pkg in REQUIRED_PACKAGES:
        if importlib.util.find_spec(pkg) is None:
            missing_packages.append(pkg)
    if missing_packages:
        try:
            subprocess.check_call([sys.executable, "-m", "pip", "install", "--upgrade", "pip"],
                                  stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
            subprocess.check_call([sys.executable, "-m", "pip", "install"] + missing_packages,
                                  stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
        except Exception as e:
            with open(CRASH_LOG, "w", encoding="utf-8") as f:
                f.write("Error installing packages:\n")
                f.write(str(e))
            raise

def create_files():
    os.makedirs(DATA_FOLDER, exist_ok=True)

    # Write Browser.py
    with open(BROWSER_FILE, "w", encoding="utf-8") as f:
        f.write('import sys\nimport os\nimport json\nimport shutil\nimport datetime\nimport traceback\n\nfrom cryptography.fernet import Fernet\n\nfrom PyQt6.QtWidgets import (\n    QApplication, QMainWindow, QVBoxLayout, QWidget, QLineEdit,\n    QPushButton, QHBoxLayout, QTabWidget, QMessageBox, QDialog,\n    QListWidget, QLabel, QInputDialog, QFileDialog\n)\nfrom PyQt6.QtGui import QIcon, QPixmap, QColor, QAction\nfrom PyQt6.QtCore import QUrl, QObject, pyqtSlot, QTimer\n\nfrom PyQt6.QtWebEngineWidgets import QWebEngineView\nfrom PyQt6.QtWebEngineCore import QWebEngineProfile\nfrom PyQt6.QtWebChannel import QWebChannel\n\nprint("Debug mode is on")\nprint("Running Browser")\n\n# ------------------- Crash Logging -------------------\ndef write_crash_log(e):\n    os.makedirs("crash_logs", exist_ok=True)\n    timestamp = datetime.datetime.now().strftime("%Y-%m-%d_%H-%M-%S")\n    filename = os.path.join("crash_logs", f"crash_{timestamp}.txt")\n    with open(filename, "w", encoding="utf-8") as f:\n        f.write("Crash Report\\n")\n        f.write("="*40 + "\\n")\n        traceback.print_exc(file=f)\n    print(f"Crash logged to {filename}")\n\n# ------------------- Password Handler -------------------\nclass PasswordHandler(QObject):\n    def __init__(self, password_file, cipher, save_passwords=True):\n        super().__init__()\n        self.password_file = password_file\n        self.cipher = cipher\n        self.save_passwords = save_passwords\n\n    @pyqtSlot(str, str)\n    def ask_save_password(self, username, password):\n        if not password or not self.save_passwords:\n            return\n        reply = QMessageBox.question(None, "Save Password",\n                                     f"Do you want to save your password for {username}?",\n                                     QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No)\n        if reply == QMessageBox.StandardButton.Yes:\n            data = {}\n            if os.path.exists(self.password_file):\n                try:\n                    encrypted = open(self.password_file, "rb").read()\n                    if encrypted:\n                        data = json.loads(self.cipher.decrypt(encrypted).decode())\n                except Exception:\n                    data = {}\n            data[username] = {"username": username, "password": password}\n            encrypted = self.cipher.encrypt(json.dumps(data).encode())\n            with open(self.password_file, "wb") as f:\n                f.write(encrypted)\n            QMessageBox.information(None, "Saved!", f"Saved credentials for {username}!")\n\n# ------------------- Browser -------------------\nclass Browser(QMainWindow):\n    def __init__(self, username, save_passwords=True):\n        super().__init__()\n        self.username = username\n        self.homepage = "https://newtab.fwh.is/"\n        self.save_passwords = save_passwords\n        self.setWindowTitle(f"Browser - {username}")\n        self.setGeometry(100, 100, 1200, 800)\n\n        # User folders\n        self.user_folder = os.path.join("data", "users", username)\n        os.makedirs(self.user_folder, exist_ok=True)\n        self.history_file = os.path.join(self.user_folder, "history.txt")\n        self.bookmarks_file = os.path.join(self.user_folder, "bookmarks.txt")\n        self.password_file = os.path.join(self.user_folder, "passwords.bin")\n        self.cookies_path = os.path.join(self.user_folder, "cookies")\n        os.makedirs(self.cookies_path, exist_ok=True)\n\n        # Encryption key\n        key_file = os.path.join(self.user_folder, "key.key")\n        if not os.path.exists(key_file):\n            with open(key_file, "wb") as f:\n                f.write(Fernet.generate_key())\n        key = open(key_file, "rb").read()\n        self.cipher = Fernet(key)\n\n        # Persistent cookies\n        profile = QWebEngineProfile.defaultProfile()\n        profile.setPersistentCookiesPolicy(QWebEngineProfile.PersistentCookiesPolicy.ForcePersistentCookies)\n        try:\n            profile.setPersistentStoragePath(self.cookies_path)\n        except Exception:\n            pass\n\n        # Tabs and UI\n        self.tabs = QTabWidget()\n        self.tabs.setTabsClosable(True)\n        self.tabs.tabCloseRequested.connect(self.close_tab)\n        self.tabs.currentChanged.connect(self.update_urlbar_on_tab_change)\n\n        self.channel = QWebChannel()\n        self.password_handler = PasswordHandler(self.password_file, self.cipher, self.save_passwords)\n        self.channel.registerObject("passwordHandler", self.password_handler)\n\n        # Toolbar\n        self.url_bar = QLineEdit()\n        self.url_bar.returnPressed.connect(self.load_url)\n        self.back_button = QPushButton("<")\n        self.back_button.clicked.connect(self.back)\n        self.forward_button = QPushButton(">")\n        self.forward_button.clicked.connect(self.forward)\n        self.refresh_button = QPushButton("âŸ³")\n        self.refresh_button.clicked.connect(self.refresh)\n        self.go_button = QPushButton("Go")\n        self.go_button.clicked.connect(self.load_url)\n        self.bookmark_button = QPushButton("â˜†")\n        self.bookmark_button.clicked.connect(self.add_bookmark)\n        self.new_tab_button = QPushButton("+")\n        self.new_tab_button.clicked.connect(lambda: self.add_tab())\n        self.settings_button = QPushButton("âš™")\n        self.settings_button.clicked.connect(self.open_settings)\n        self.file_button = QPushButton("ðŸ“‚")\n        self.file_button.clicked.connect(self.open_file)\n\n        top_layout = QHBoxLayout()\n        for w in [self.back_button, self.forward_button, self.refresh_button, self.url_bar,\n                  self.go_button, self.bookmark_button, self.new_tab_button, self.settings_button, self.file_button]:\n            top_layout.addWidget(w)\n        main_layout = QVBoxLayout()\n        main_layout.addLayout(top_layout)\n        main_layout.addWidget(self.tabs)\n\n        container = QWidget()\n        container.setLayout(main_layout)\n        self.setCentralWidget(container)\n\n        # Menus\n        self.menu = self.menuBar()\n        self.bookmarks_menu = self.menu.addMenu("Bookmarks")\n        self.history_menu = self.menu.addMenu("History")\n        self.more_menu = self.menu.addMenu("More")\n        self.update_bookmarks_menu()\n        self.update_history_menu()\n        self.setup_more_menu()\n\n        # Spinner & default icon\n        self.spinner_timer = QTimer()\n        self.spinner_timer.timeout.connect(self.rotate_spinner)\n        self.spinner_angle = 0\n        self.default_icon = self.generate_pixmap("#777")\n\n        # Load homepage\n        self.add_tab(self.homepage)\n\n    # -------- Tab Management --------\n    def close_tab(self, index):\n        if self.tabs.count() > 1:\n            self.tabs.removeTab(index)\n\n    def add_tab(self, url=None):\n        if not url:\n            url = self.homepage\n        browser = QWebEngineView()\n        try:\n            browser.page().setWebChannel(self.channel)\n        except Exception:\n            pass\n        browser.setUrl(QUrl(url))\n        browser.titleChanged.connect(lambda t, b=browser: self.update_tab_title(t, b))\n        browser.iconChanged.connect(lambda i, b=browser: self.update_tab_icon(i, b))\n        browser.urlChanged.connect(lambda q, b=browser: self.update_url_bar(q, b))\n        browser.loadStarted.connect(lambda b=browser: self.set_spinner_icon(b))\n        browser.loadFinished.connect(lambda ok, b=browser: self.on_load_finished(ok, b))\n        i = self.tabs.addTab(browser, "Loading...")\n        self.tabs.setTabIcon(i, self.default_icon)\n        self.tabs.setCurrentIndex(i)\n\n    def on_load_finished(self, ok, browser):\n        try: self.save_history(browser)\n        except: pass\n        try: self.inject_js(browser)\n        except: pass\n        try: self.spinner_timer.stop()\n        except: pass\n        for idx in range(self.tabs.count()):\n            if self.tabs.widget(idx) == browser:\n                icon = browser.icon()\n                if icon.isNull():\n                    self.tabs.setTabIcon(idx, self.default_icon)\n\n    # -------- Navigation --------\n    def load_url(self):\n        url = self.url_bar.text().strip()\n        if not (url.startswith("http://") or url.startswith("https://") or url.startswith("file://")):\n            url = "https://" + url\n        try: self.current_browser().setUrl(QUrl(url))\n        except: pass\n\n    def update_url_bar(self, q, browser):\n        if browser == self.current_browser():\n            try: self.url_bar.setText(q.toString())\n            except: self.url_bar.setText("")\n\n    def update_urlbar_on_tab_change(self, _):\n        if self.current_browser():\n            try: self.url_bar.setText(self.current_browser().url().toString())\n            except: self.url_bar.setText("")\n\n    def back(self): \n        try: self.current_browser().back()\n        except: pass\n    def forward(self): \n        try: self.current_browser().forward()\n        except: pass\n    def refresh(self): \n        try: self.current_browser().reload()\n        except: pass\n\n    def current_browser(self):\n        w = self.tabs.currentWidget()\n        return w if isinstance(w, QWebEngineView) else None\n\n    # -------- Tab visuals --------\n    def update_tab_title(self, title, browser):\n        for i in range(self.tabs.count()):\n            if self.tabs.widget(i) == browser: self.tabs.setTabText(i, title)\n\n    def update_tab_icon(self, icon, browser):\n        if icon.isNull(): icon = self.default_icon\n        for i in range(self.tabs.count()):\n            if self.tabs.widget(i) == browser: self.tabs.setTabIcon(i, icon)\n\n    def generate_pixmap(self, hex_color, size=16):\n        pm = QPixmap(size, size)\n        pm.fill(QColor(hex_color))\n        return QIcon(pm)\n\n    def set_spinner_icon(self, browser):\n        try: self.spinner_timer.start(50)\n        except: pass\n        for i in range(self.tabs.count()):\n            if self.tabs.widget(i) == browser: self.tabs.setTabIcon(i, self.default_icon)\n\n    def rotate_spinner(self):\n        self.spinner_angle = (self.spinner_angle + 1) % 360\n        try: color = QColor.fromHsv(self.spinner_angle, 255, 200).name()\n        except: color = "#888888"\n        icon = self.generate_pixmap(color)\n        for i in range(self.tabs.count()): self.tabs.setTabIcon(i, icon)\n\n    # -------- History & Bookmarks --------\n    def save_history(self, browser):\n        try: url = browser.url().toString()\n        except: url = ""\n        if url:\n            with open(self.history_file, "a", encoding="utf-8") as f:\n                f.write(url+"\\n")\n            self.update_history_menu()\n\n    def update_history_menu(self):\n        self.history_menu.clear()\n        if os.path.exists(self.history_file):\n            with open(self.history_file, "r", encoding="utf-8") as f:\n                urls = list(dict.fromkeys(f.read().splitlines()))[-20:]\n            for u in urls:\n                a = QAction(u, self)\n                a.triggered.connect(lambda checked, url=u: self.current_browser().setUrl(QUrl(url)))\n                self.history_menu.addAction(a)\n\n    def add_bookmark(self):\n        try: url = self.current_browser().url().toString()\n        except: url = ""\n        if not url: return\n        with open(self.bookmarks_file, "a", encoding="utf-8") as f: f.write(url+"\\n")\n        QMessageBox.information(self, "Bookmarked!", f"Added {url}")\n        self.update_bookmarks_menu()\n\n    def update_bookmarks_menu(self):\n        self.bookmarks_menu.clear()\n        if os.path.exists(self.bookmarks_file):\n            with open(self.bookmarks_file, "r", encoding="utf-8") as f:\n                urls = list(dict.fromkeys(f.read().splitlines()))\n            for u in urls:\n                a = QAction(u, self)\n                a.triggered.connect(lambda checked, url=u: self.current_browser().setUrl(QUrl(url)))\n                self.bookmarks_menu.addAction(a)\n\n    # -------- Settings & More --------\n    def setup_more_menu(self):\n        about = QAction("About Browser", self)\n        about.triggered.connect(lambda: QMessageBox.information(self, "About", f"User: {self.username}\\nTabs: {self.tabs.count()}"))\n        self.more_menu.addAction(about)\n\n    def open_settings(self):\n        text, ok = QInputDialog.getText(self, "Settings", "Set homepage:", text=self.homepage)\n        if ok and text: self.homepage = text\n        reply = QMessageBox.question(self, "Passwords", "Enable password saving?", \n                                     QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No)\n        self.save_passwords = reply == QMessageBox.StandardButton.Yes\n        self.password_handler.save_passwords = self.save_passwords\n\n    # -------- Open local file --------\n    def open_file(self):\n        file, _ = QFileDialog.getOpenFileName(self, "Open HTML File", "", "HTML Files (*.html *.htm)")\n        if file: self.current_browser().setUrl(QUrl.fromLocalFile(file))\n\n    # -------- JS Password Autofill --------\n    def inject_js(self, browser):\n        js_autofill = ""\n        if os.path.exists(self.password_file):\n            try:\n                encrypted = open(self.password_file, "rb").read()\n                if encrypted:\n                    data = json.loads(self.cipher.decrypt(encrypted).decode())\n                    for site, creds in data.items():\n                        safe_site = site.replace(\'"\', \'\\\\"\')\n                        safe_user = creds.get("username","").replace(\'"\',\'\\\\"\')\n                        safe_pass = creds.get("password","").replace(\'"\',\'\\\\"\')\n                        js_autofill += f"""\n                            document.querySelectorAll(\'input[type=text]\').forEach(u => {{\n                                try {{ if(u.value=="" && window.location.href.includes("{safe_site}")) u.value="{safe_user}"; }} catch(e){{}}\n                            }});\n                            document.querySelectorAll(\'input[type=password]\').forEach(p => {{\n                                try {{ if(p.value=="" && window.location.href.includes("{safe_site}")) p.value="{safe_pass}"; }} catch(e){{}}\n                            }});\n                        """\n            except: pass\n\n        js = f"""\n            if (typeof qt !== \'undefined\') {{\n                document.querySelectorAll(\'form\').forEach(form => {{\n                    form.addEventListener(\'submit\', ()=> {{\n                        try {{\n                            const userField = form.querySelector("input[type=text]");\n                            const passField = form.querySelector("input[type=password]");\n                            const user = userField?userField.value:"";\n                            const pass = passField?passField.value:"";\n                            if(pass) qt.passwordHandler.ask_save_password(user, pass);\n                        }} catch(e){{}}\n                    }});\n                }});\n            }}\n            {js_autofill}\n        """\n        try: browser.page().runJavaScript(js)\n        except: pass\n\n# ------------------- User Selection Dialog -------------------\nclass UserSelectionDialog(QDialog):\n    def __init__(self, parent=None):\n        super().__init__(parent)\n        self.setWindowTitle("Select User")\n        self.setFixedSize(400, 300)\n        layout = QVBoxLayout()\n        layout.addWidget(QLabel("Choose a user or create a new one:"))\n        self.user_list = QListWidget()\n        self.user_folder = os.path.join("data", "users")\n        os.makedirs(self.user_folder, exist_ok=True)\n        self.user_list.addItems(os.listdir(self.user_folder))\n        layout.addWidget(self.user_list)\n        btn_layout = QHBoxLayout()\n        self.new_user_btn = QPushButton("Create New User")\n        self.delete_user_btn = QPushButton("Delete User")\n        self.ok_btn = QPushButton("Login")\n        btn_layout.addWidget(self.new_user_btn)\n        btn_layout.addWidget(self.delete_user_btn)\n        btn_layout.addWidget(self.ok_btn)\n        layout.addLayout(btn_layout)\n        self.setLayout(layout)\n        self.selected_user = None\n        self.save_passwords = True\n        self.new_user_btn.clicked.connect(self.create_new_user)\n        self.delete_user_btn.clicked.connect(self.delete_user)\n        self.ok_btn.clicked.connect(self.login)\n\n    def create_new_user(self):\n        text, ok = QInputDialog.getText(self, "New User", "Enter username:")\n        if ok and text:\n            self.selected_user = text\n            reply = QMessageBox.question(self, "Password Saving",\n                                         f"Allow saving passwords for {text}?",\n                                         QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No)\n            self.save_passwords = reply == QMessageBox.StandardButton.Yes\n            os.makedirs(os.path.join(self.user_folder, text), exist_ok=True)\n            self.accept()\n\n    def delete_user(self):\n        item = self.user_list.currentItem()\n        if item:\n            reply = QMessageBox.question(self, "Delete User",\n                                         f"Are you sure you want to delete {item.text()}?",\n                                         QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No)\n            if reply == QMessageBox.StandardButton.Yes:\n                shutil.rmtree(os.path.join(self.user_folder, item.text()))\n                self.user_list.takeItem(self.user_list.row(item))\n\n    def login(self):\n        item = self.user_list.currentItem()\n        if item:\n            self.selected_user = item.text()\n            reply = QMessageBox.question(self, "Password Saving",\n                                         f"Allow saving passwords for {self.selected_user}?",\n                                         QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No)\n            self.save_passwords = reply == QMessageBox.StandardButton.Yes\n            self.accept()\n        else:\n            QMessageBox.warning(self, "No User Selected", "Please select a user or create a new one.")\n\n# ------------------- Main -------------------\nif __name__ == "__main__":\n    try:\n        app = QApplication(sys.argv)\n        dialog = UserSelectionDialog()\n        if dialog.exec() == QDialog.DialogCode.Accepted:\n            username = dialog.selected_user\n            save_passwords = dialog.save_passwords\n            print(f"Running Browser as user: {username}")\n            window = Browser(username, save_passwords)\n            window.show()\n            sys.exit(app.exec())\n    except Exception as e:\n        write_crash_log(e)\n        QMessageBox.critical(None, "Unexpected Error", "The browser crashed. See crash_logs folder.")\n        sys.exit(1)\n')

    # Write RunBrowser.bat (silent launch, actual Browser.py path)
    run_text = f"""@echo off
start "" pythonw "{BROWSER_FILE}"
"""
    with open(RUN_FILE, "w", encoding="utf-8") as f:
        f.write(run_text)

    # Write INFO.txt
    info_text = "Mini Python Browser - INFO\n\nVersion: 1.0\nDeveloper: Gavin Codework\nRelease Date: 2025-11-29\n"
    with open(INFO_FILE, "w", encoding="utf-8") as f:
        f.write(info_text)

if __name__ == "__main__":
    try:
        install_packages()
        create_files()
    except Exception:
        with open(CRASH_LOG, "w", encoding="utf-8") as f:
            f.write("Crash during setup:\n")
            f.write(traceback.format_exc())
